<!DOCTYPE html>
<html data-bs-theme="light" lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Doctor Colóncio - Asistente EII</title>
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css?family=Inter:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800&amp;display=swap">
    <link rel="stylesheet" href="assets/css/swiper-icons.css">
    <link rel="stylesheet" href="assets/css/bs-theme-overrides.css">
    <link rel="stylesheet" href="assets/css/Simple-Slider-swiper-bundle.min.css">
    <link rel="stylesheet" href="assets/css/Simple-Slider.css">
    <link rel="stylesheet" href="assets/css/Team-icons.css">
    <link rel="stylesheet" href="assets/css/Team-images.css">
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            display: flex;
            flex-direction: column;
        }

        #main-content {
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
            min-height: 0;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        #chat-section {
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
            min-height: 0;
            margin-bottom: 0;
            height: calc(100dvh - 80px - 70px); /* 70px input, 80px margen inferior */
            max-height: calc(100dvh - 80px - 70px);
        }

        #chat-container {
            flex: 1 1 auto;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 0;
            box-sizing: border-box;
        }

        #chat-container .message:last-child {
            margin-bottom: 10px !important;
        }

        #input-section {
            width: 100%;
            position: fixed;
            left: 0;
            right: 0;
            bottom: 80px;
            /* deja 80px de margen inferior */
            background: white;
            z-index: 1000;
        }

        #input-container {
            display: flex;
            padding: 10px;
            background-color: white;
            border-top: 1px solid #ddd;
            width: 100%;
            box-sizing: border-box;
        }

        #input-container input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        #input-container button {
            margin-left: 10px;
            padding: 10px 20px;
            background-color: #cb658e;
            color: white;
            border: none;
            border-radius: 5px;
        }

        .message {
            display: flex;
            align-items: center;
            max-width: 80%;
            margin-bottom: 5px;
            padding: 10px 15px;
            border-radius: 15px;
            animation: fadeIn 0.3s ease-in-out;
        }

        .message img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .message.user {
            background-color: #cb658e;
            color: white;
            align-self: flex-end;
            flex-direction: row-reverse;
            justify-content: flex-end;
            margin-left: auto;
            text-align: right;
        }

        .message.user img {
            margin-left: 10px;
            margin-right: 0;
            display: inline-block;
            text-align: right;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .message.assistant {
            background-color: #978bc4;
            color: black;
            align-self: flex-start;
            text-align: left;
        }

        #suggestions {
            margin-bottom: 10px;
            margin-top: 30px;
        }

        #suggestions button {
            margin: 5px;
            padding: 5px 10px;
            background-color: #e9ecef;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #suggestions button:hover {
            background-color: #cb658e;
            color: white;
        }

        .btn-custom {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px 10px;
            font-size: 14px;
            font-weight: normal;
            background-color: #fdfdfd;
            color: #333;
            border: none;
            border-radius: 5px;
            gap: 5px;
            box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn-custom img {
            width: 16px;
            height: 16px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        body.dark-mode {
            background-color: #121212;
            color: #f1f1f1;
        }

        body.dark-mode .message.user {
            background-color: #bb4b6c;
        }

        body.dark-mode .message.assistant {
            background-color: #333333;
            color: #f1f1f1;
        }

        body.dark-mode #input-container {
            background-color: #1e1e1e;
            border-top: 1px solid #333;
        }

        body.dark-mode #chat-container {
            background-color: #1e1e1e;
            border: 1px solid #333;
        }

        body.dark-mode #suggestions button {
            background-color: #333;
            color: #f1f1f1;
        }

        body.dark-mode #suggestions button:hover {
            background-color: #bb4b6c;
        }

        /* Indicador de estado del servidor */
        .server-status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background-color: #f8f9fa;
            border-radius: 20px;
            border: 1px solid #dee2e6;
            font-size: 14px;
            font-weight: 500;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #6c757d;
            animation: pulse 2s infinite;
        }

        .status-dot.online {
            background-color: #28a745;
            animation: none;
        }

        .status-dot.waking {
            background-color: #ffc107;
            animation: pulse 1s infinite;
        }

        .status-dot.offline {
            background-color: #dc3545;
            animation: none;
        }

        .status-text {
            color: #6c757d;
            font-size: 12px;
        }

        .status-text.online {
            color: #28a745;
        }

        .status-text.waking {
            color: #ffc107;
        }

        .status-text.offline {
            color: #dc3545;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        /* Estilos para modo oscuro */
        body.dark-mode .server-status-indicator {
            background-color: #2d3748;
            border-color: #4a5568;
        }

        body.dark-mode .status-text {
            color: #a0aec0;
        }

        /* Etiquetas de categoría */
        .category-tag {
            position: absolute;
            top: -8px;
            right: 10px;
            background-color: #cb658e;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 500;
            z-index: 10;
        }

        .message {
            position: relative;
            font-size: 0.8rem;
            /* Aumenta el tamaño de letra */
            word-break: break-word;
            /* Evita que el texto se salga de la burbuja */
            white-space: pre-line;
            /* Respeta saltos de línea */
            max-width: 95vw;
            /* Mejor para móviles */
            margin-bottom: 5px;
        }

        @media (max-width: 600px) {
            .message {
                font-size: 0.8rem;
                padding: 10px 8px;
                max-width: 98vw;
            }

            #input-container input {
                font-size: 0.8rem;
            }
        }

        body.dark-mode .category-tag {
            background-color: #bb4b6c;
        }

        /* Menú de exportación */
        .export-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .export-menu-content {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
        }

        .export-menu-content h6 {
            margin: 0 0 15px 0;
            text-align: center;
            color: #333;
            font-size: 18px;
        }

        .export-btn {
            display: block;
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: none;
            border-radius: 8px;
            background-color: #f8f9fa;
            color: #333;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .export-btn:hover {
            background-color: #cb658e;
            color: white;
        }

        .export-btn.cancel {
            background-color: #dc3545;
            color: white;
        }

        .export-btn.cancel:hover {
            background-color: #c82333;
        }

        body.dark-mode .export-menu-content {
            background-color: #2d3748;
            color: #f1f1f1;
        }

        body.dark-mode .export-menu-content h6 {
            color: #f1f1f1;
        }

        body.dark-mode .export-btn {
            background-color: #4a5568;
            color: #f1f1f1;
        }

        body.dark-mode .export-btn:hover {
            background-color: #bb4b6c;
        }

        /* Header de sugerencias inteligentes */
        .suggestions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px 12px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .suggestions-header span {
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }

        .refresh-suggestions {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .refresh-suggestions:hover {
            background-color: #cb658e;
            color: white;
        }

        body.dark-mode .suggestions-header {
            background-color: #2d3748;
            border-color: #4a5568;
        }

        body.dark-mode .suggestions-header span {
            color: #e2e8f0;
        }

        /* Botones de sugerencias inteligentes */
        .suggestion-btn {
            margin: 5px;
            padding: 8px 12px;
            background-color: #e9ecef;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            max-width: 100%;
            word-wrap: break-word;
            text-align: left;
            line-height: 1.3;
        }

        .suggestion-btn:hover {
            background-color: #cb658e;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(203, 101, 142, 0.3);
        }

        .suggestion-btn:active {
            transform: translateY(0);
        }

        body.dark-mode .suggestion-btn {
            background-color: #4a5568;
            color: #e2e8f0;
        }

        body.dark-mode .suggestion-btn:hover {
            background-color: #bb4b6c;
            color: white;
        }
    </style>
</head>

<body>
    <div id="main-content">
        <div class="container my-3">
            <div class="row">
                <div class="col">
                    <div class="d-flex justify-content-between mt-3">
                        <div class="d-flex align-items-center">
                            <div id="server-status" class="server-status-indicator me-2" title="Estado del servidor">
                                <span id="status-dot" class="status-dot"></span>
                                <span id="status-text" class="status-text">Verificando...</span>
                            </div>
                        </div>
                        <div class="d-flex">
                            <button onclick="exportChat()" class="btn-custom me-2">
                                <img src="/app/assets/export.png" alt="Exportar">Exportar
                            </button>
                            <!-- <button id="theme-toggle" class="btn-custom">
                            <img src="/app/assets/switch_mode.png" alt="Modo Oscuro">Modo Oscuro
                            </button> -->
                            <button onclick="clearChat()" class="btn-custom">
                                <img src="/app/assets/delete.png" alt="Vaciar">Vaciar Chat
                            </button>
                        </div>
                    </div>
                    <div id="suggestions">
                        <div class="suggestions-header">
                            <span>💡 Sugerencias inteligentes</span>
                            <button onclick="refreshSuggestions()" class="refresh-suggestions"
                                title="Actualizar sugerencias">
                                🔄
                            </button>
                        </div>
                        <div id="suggestions-container">
                            <!-- Las sugerencias se generarán dinámicamente aquí -->
                        </div>
                    </div>
                    <div id="chat-section">
                        <div id="chat-container">
                            <!-- Los mensajes se agregarán aquí dinámicamente -->
                        </div>
                    </div>
                    <div id="input-section">
                        <div id="input-container">
                            <input id="user-input" type="text" placeholder="Escribe tu mensaje..." />
                            <button id="send-btn">Enviar</button>
                        </div>
                    </div>
                </div>

                <script src="https://unpkg.com/twemoji@latest/dist/twemoji.min.js"></script>
                <script>
                    const chatContainer = document.getElementById("chat-container");
                    const userInput = document.getElementById("user-input");
                    const sendButton = document.getElementById("send-btn");
                    const toggleButton = document.getElementById("theme-toggle");

                    function addMessage(content, role) {
                        const messageDiv = document.createElement("div");
                        messageDiv.classList.add("message", role);

                        const img = document.createElement("img");
                        img.src = role === "user" ? "/app/assets/user.png" : "/app/assets/drColoncio.png";

                        const text = document.createElement("span");
                        text.textContent = content;

                        messageDiv.appendChild(img);
                        messageDiv.appendChild(text);

                        chatContainer.appendChild(messageDiv);
                        chatContainer.scrollTop = chatContainer.scrollHeight; // Desplazar hacia el último mensaje
                        renderEmojis();
                        saveChatHistory();
                    }

                    async function addTypingIndicator() {
                        const typingIndicator = document.createElement("div");
                        typingIndicator.classList.add("message", "assistant");
                        typingIndicator.textContent = "Doctor Colóncio está escribiendo...";
                        chatContainer.appendChild(typingIndicator);
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                        return typingIndicator;
                    }

                    function removeTypingIndicator(indicator) {
                        chatContainer.removeChild(indicator);
                    }

                    // Base de conocimiento para sugerencias inteligentes
                    const suggestionDatabase = {
                        sintomas: {
                            general: [
                                '¿Cómo puedo saber si mis síntomas son normales?',
                                '¿Qué síntomas deberían preocuparme más?',
                                '¿Cómo puedo controlar mejor mis síntomas?'
                            ],
                            dolor: [
                                '¿Qué puedo hacer para aliviar el dolor?',
                                '¿Cuándo debería preocuparme por el dolor?',
                                '¿Hay ejercicios que ayuden con el dolor?'
                            ],
                            digestivos: [
                                '¿Qué cambios en mis deposiciones son normales?',
                                '¿Cómo puedo mejorar mi digestión?',
                                '¿Qué alimentos me ayudarán con las náuseas?'
                            ]
                        },
                        tratamiento: {
                            medicamentos: [
                                '¿Qué efectos secundarios puedo esperar?',
                                '¿Cómo sé si mi medicación está funcionando?',
                                '¿Qué hago si olvido tomar mi medicamento?'
                            ],
                            seguimiento: [
                                '¿Con qué frecuencia debo hacerme revisiones?',
                                '¿Qué pruebas necesito regularmente?',
                                '¿Cómo sé si mi tratamiento necesita ajustes?'
                            ]
                        },
                        dieta: {
                            general: [
                                '¿Qué dieta me recomiendas para la EII?',
                                '¿Hay alimentos que debo evitar completamente?',
                                '¿Cómo puedo mantener una dieta equilibrada?'
                            ],
                            suplementos: [
                                '¿Qué vitaminas me recomiendas tomar?',
                                '¿Los probióticos me pueden ayudar?',
                                '¿Qué suplementos son seguros para la EII?'
                            ]
                        },
                        vida_cotidiana: {
                            ejercicio: [
                                '¿Qué tipo de ejercicio es seguro para mí?',
                                '¿Cómo puedo hacer deporte sin empeorar mis síntomas?',
                                '¿Qué actividades me recomiendas para mantenerme activo?'
                            ],
                            trabajo: [
                                '¿Cómo puedo manejar la EII en el trabajo?',
                                '¿Qué adaptaciones laborales puedo solicitar?',
                                '¿Cómo manejo el estrés sin afectar mi enfermedad?'
                            ]
                        },
                        emergencia: [
                            '⚠️ ¿Qué síntomas requieren atención médica inmediata?',
                            '🚨 ¿Cuándo debo ir a urgencias?',
                            '📞 ¿Cómo sé si necesito llamar al médico?'
                        ]
                    };

                    // Sugerencias por defecto para nuevos usuarios
                    const defaultSuggestions = [
                        '¿Qué es la enfermedad de Crohn?',
                        '¿Cuáles son los síntomas más frecuentes en una EII?',
                        '¿Cómo se diagnostica una EII?'
                    ];

                    function analyzeChatContext() {
                        const messages = Array.from(chatContainer.children);
                        const userMessages = messages.filter(msg => msg.classList.contains('user'));

                        if (userMessages.length === 0) {
                            return { categories: [], context: 'new_user' };
                        }

                        // Analizar los últimos 5 mensajes del usuario
                        const recentMessages = userMessages.slice(-5);
                        const categories = new Set();
                        const keywords = new Set();

                        recentMessages.forEach(msg => {
                            const category = msg.getAttribute('data-category');
                            if (category) categories.add(category);

                            const content = msg.querySelector('span').textContent.toLowerCase();
                            // Extraer palabras clave
                            const words = content.split(/\s+/).filter(word => word.length > 3);
                            words.forEach(word => keywords.add(word));
                        });

                        return {
                            categories: Array.from(categories),
                            keywords: Array.from(keywords),
                            context: 'ongoing_conversation'
                        };
                    }

                    function generateSmartSuggestions() {
                        const context = analyzeChatContext();
                        const suggestions = [];

                        // Si es un usuario nuevo, mostrar sugerencias básicas
                        if (context.context === 'new_user' || context.categories.length === 0) {
                            return defaultSuggestions;
                        }

                        // Generar sugerencias basadas en las categorías detectadas
                        context.categories.forEach(category => {
                            if (suggestionDatabase[category]) {
                                const categorySuggestions = suggestionDatabase[category];
                                // Tomar sugerencias de diferentes subcategorías
                                Object.values(categorySuggestions).forEach(subSuggestions => {
                                    if (Array.isArray(subSuggestions)) {
                                        suggestions.push(...subSuggestions);
                                    }
                                });
                            }
                        });

                        // Agregar sugerencias de emergencia si hay síntomas
                        if (context.categories.includes('sintomas')) {
                            suggestions.push(...suggestionDatabase.emergencia);
                        }

                        // Agregar sugerencias de seguimiento si hay tratamiento
                        if (context.categories.includes('tratamiento')) {
                            suggestions.push(...suggestionDatabase.tratamiento.seguimiento);
                        }

                        // Mezclar y limitar a 4 sugerencias
                        const shuffled = suggestions.sort(() => 0.5 - Math.random());
                        return shuffled.slice(0, 4);
                    }

                    function renderSuggestions() {
                        const container = document.getElementById('suggestions-container');
                        const suggestions = generateSmartSuggestions();

                        container.innerHTML = '';

                        suggestions.forEach(suggestion => {
                            const button = document.createElement('button');
                            button.className = 'suggestion-btn';
                            button.textContent = suggestion;
                            button.onclick = () => sendPredefinedMessage(suggestion);
                            container.appendChild(button);
                        });
                    }

                    function refreshSuggestions() {
                        renderSuggestions();
                    }

                    async function sendPredefinedMessage(message) {
                        userInput.value = message;
                        sendButton.click();

                        // Regenerar sugerencias después de enviar un mensaje
                        setTimeout(renderSuggestions, 1000);
                    }

                    function saveChatHistory() {
                        const messages = Array.from(chatContainer.children).map((msg) => {
                            const role = msg.classList.contains("user") ? "Usuario" : "Doctor Colóncio";
                            const content = msg.querySelector("span").textContent;
                            const timestamp = msg.getAttribute("data-timestamp");
                            return { role, content, timestamp }; // Guardamos como un objeto JSON
                        });
                        localStorage.setItem("chatHistory", JSON.stringify(messages));
                    }


                    function loadChatHistory() {
                        const savedMessages = JSON.parse(localStorage.getItem("chatHistory")) || [];
                        savedMessages.forEach((msg) => {
                            const { role, content, timestamp } = msg; // Extraemos los datos directamente del objeto
                            addMessageWithTimestamp(content, role === "Usuario" ? "user" : "assistant", timestamp);
                        });
                    }

                    function clearChat() {
                        // Elimina todos los elementos hijos del contenedor de chat
                        while (chatContainer.firstChild) {
                            chatContainer.removeChild(chatContainer.firstChild);
                        }
                        // Limpia el historial almacenado en localStorage
                        localStorage.removeItem("chatHistory");
                        console.log("Chat eliminado.");
                    }



                    function categorizeMessage(content) {
                        const lowerContent = content.toLowerCase();
                        const categories = {
                            'sintomas': ['dolor', 'diarrea', 'estreñimiento', 'náusea', 'vómito', 'fiebre', 'cansancio', 'pérdida de peso', 'sangrado'],
                            'tratamiento': ['medicamento', 'fármaco', 'terapia', 'tratamiento', 'dosis', 'inyección', 'infusión'],
                            'dieta': ['alimentación', 'comida', 'dieta', 'nutrición', 'vitaminas', 'suplementos', 'intolerancia', 'alergia'],
                            'diagnostico': ['prueba', 'análisis', 'endoscopia', 'colonoscopia', 'biopsia', 'resonancia', 'tomografía'],
                            'complicaciones': ['fístula', 'absceso', 'estenosis', 'perforación', 'cáncer', 'tumor'],
                            'vida_cotidiana': ['ejercicio', 'trabajo', 'viaje', 'deporte', 'estrés', 'ansiedad', 'depresión']
                        };

                        for (const [category, keywords] of Object.entries(categories)) {
                            if (keywords.some(keyword => lowerContent.includes(keyword))) {
                                return category;
                            }
                        }
                        return 'general';
                    }

                    function addMessageWithTimestamp(content, role, timestamp = new Date().toLocaleString()) {
                        const messageDiv = document.createElement("div");
                        messageDiv.classList.add("message", role);
                        messageDiv.setAttribute("data-timestamp", timestamp);

                        // Categorizar el mensaje
                        const category = categorizeMessage(content);
                        messageDiv.setAttribute("data-category", category);

                        const img = document.createElement("img");
                        img.src = role === "user" ? "/app/assets/user.png" : "/app/assets/drColoncio.png";

                        const text = document.createElement("span");
                        text.textContent = content;

                        // Agregar etiqueta de categoría si es del usuario
                        if (role === "user") {
                            const categoryTag = document.createElement("div");
                            categoryTag.className = "category-tag";
                            categoryTag.textContent = getCategoryLabel(category);
                            messageDiv.appendChild(categoryTag);
                        }

                        messageDiv.appendChild(img);
                        messageDiv.appendChild(text);

                        chatContainer.appendChild(messageDiv);
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                        renderEmojis();
                    }

                    function getCategoryLabel(category) {
                        const labels = {
                            'sintomas': '🩺 Síntomas',
                            'tratamiento': '💊 Tratamiento',
                            'dieta': '🍽️ Dieta',
                            'diagnostico': '🔬 Diagnóstico',
                            'complicaciones': '⚠️ Complicaciones',
                            'vida_cotidiana': '🏃 Vida Cotidiana',
                            'general': '💬 General'
                        };
                        return labels[category] || '💬 General';
                    }

                    // ...existing code...
                    let exportMessages = [];

                    async function exportChat() {
                        const messages = Array.from(chatContainer.children).map((msg) => {
                            const role = msg.classList.contains("user") ? "Usuario" : "Doctor Colóncio";
                            const content = msg.querySelector("span").textContent;
                            const timestamp = msg.getAttribute("data-timestamp");
                            const category = msg.getAttribute("data-category");
                            const categoryLabel = getCategoryLabel(category);

                            return {
                                role,
                                content,
                                timestamp,
                                category: categoryLabel
                            };
                        });

                        // Guardar mensajes en variable global temporal
                        exportMessages = messages;

                        // Crear menú de exportación
                        const exportMenu = document.createElement("div");
                        exportMenu.className = "export-menu";
                        exportMenu.innerHTML = `
        <div class="export-menu-content">
            <h6>Exportar Chat</h6>
            <button onclick="exportAsText()" class="export-btn">
                📄 Texto (.txt)
            </button>
            <button onclick="exportAsCSV()" class="export-btn">
                📊 CSV (.csv)
            </button>
            <button onclick="exportAsHTML()" class="export-btn">
                🌐 HTML (.html)
            </button>
            <button onclick="exportAsSummary()" class="export-btn">
                📋 Resumen (.txt)
            </button>
            <button onclick="closeExportMenu()" class="export-btn cancel">
                ❌ Cancelar
            </button>
        </div>
    `;

                        // Mostrar menú
                        document.body.appendChild(exportMenu);
                    }

                    function exportAsText() {
                        const messages = exportMessages;
                        const content = messages.map(msg =>
                            `${msg.role} [${msg.timestamp}] (${msg.category}): ${msg.content}`
                        ).join("\n");

                        downloadFile(content, `chat_${new Date().toLocaleDateString().replace(/\//g, "-")}.txt`, "text/plain");
                        closeExportMenu();
                    }

                    function exportAsCSV() {
                        const messages = exportMessages;
                        const headers = "Rol,Fecha,Categoría,Contenido\n";
                        const content = headers + messages.map(msg =>
                            `"${msg.role}","${msg.timestamp}","${msg.category}","${msg.content.replace(/"/g, '""')}"`
                        ).join("\n");

                        downloadFile(content, `chat_${new Date().toLocaleDateString().replace(/\//g, "-")}.csv`, "text/csv");
                        closeExportMenu();
                    }

                    function exportAsHTML() {
                        const messages = exportMessages;
                        const htmlContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Chat con Doctor Colóncio</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .message { margin: 10px 0; padding: 10px; border-radius: 8px; }
        .user { background-color: #f0f0f0; }
        .assistant { background-color: #e3f2fd; }
        .timestamp { color: #666; font-size: 12px; }
        .category { background-color: #cb658e; color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px; }
    </style>
</head>
<body>
    <h1>Chat con Doctor Colóncio</h1>
    <p><strong>Fecha de exportación:</strong> ${new Date().toLocaleString()}</p>
    <p><strong>Total de mensajes:</strong> ${messages.length}</p>
    <hr>
    ${messages.map(msg => `
        <div class="message ${msg.role === 'Usuario' ? 'user' : 'assistant'}">
            <div class="timestamp">${msg.timestamp}</div>
            <span class="category">${msg.category}</span>
            <strong>${msg.role}:</strong> ${msg.content}
        </div>
    `).join('')}
</body>
</html>`;

                        downloadFile(htmlContent, `chat_${new Date().toLocaleDateString().replace(/\//g, "-")}.html`, "text/html");
                        closeExportMenu();
                    }

                    function exportAsSummary() {
                        const messages = exportMessages;
                        const userMessages = messages.filter(msg => msg.role === 'Usuario');
                        const categories = {};

                        userMessages.forEach(msg => {
                            const category = msg.category;
                            if (!categories[category]) categories[category] = [];
                            categories[category].push(msg.content);
                        });

                        let summary = `RESUMEN DEL CHAT - Doctor Colóncio\n`;
                        summary += `Fecha: ${new Date().toLocaleDateString()}\n`;
                        summary += `Total de mensajes: ${messages.length}\n`;
                        summary += `Mensajes del usuario: ${userMessages.length}\n\n`;

                        summary += `CATEGORÍAS CONSULTADAS:\n`;
                        for (const [category, contents] of Object.entries(categories)) {
                            summary += `\n${category} (${contents.length} consultas):\n`;
                            contents.forEach(content => {
                                summary += `  • ${content}\n`;
                            });
                        }

                        downloadFile(summary, `resumen_chat_${new Date().toLocaleDateString().replace(/\//g, "-")}.txt`, "text/plain");
                        closeExportMenu();
                    }

                    function downloadFile(content, filename, mimeType) {
                        const blob = new Blob([content], { type: mimeType });
                        const link = document.createElement("a");
                        link.href = URL.createObjectURL(blob);
                        link.download = filename;
                        link.click();
                    }

                    function closeExportMenu() {
                        const menu = document.querySelector('.export-menu');
                        if (menu) menu.remove();
                    }

                    function renderEmojis() {
                        twemoji.parse(chatContainer);
                    }

                    // Event listener para el botón de tema (solo si existe)
                    if (toggleButton) {
                        toggleButton.addEventListener("click", () => {
                            document.body.classList.toggle("dark-mode");
                        });
                    }

                    // Personalidad del Doctor Colóncio - Sistema de respuestas inteligentes
                    const doctorPersonality = {
                        // Chistes y frases características
                        catchphrases: [
                            "¡La caca no es tabú, es biología con ritmo! 🎵",
                            "Si el intestino habla, hay que escucharlo 👂",
                            "Educar es evacuar prejuicios 💩",
                            "La ciencia entra mejor con una sonrisa 😄",
                            "Cada intestino es un universo. ¡Explóralo sin miedo! 🌌",
                            "El baño es un templo. Respétalo 🏛️",
                            "Tabucio se alimenta del silencio. Yo, de la verdad! 🗣️",
                            "No hay pregunta tonta, solo intestinos tímidos 🤫",
                            "Si no te ríes de tu digestión, ella se reirá de ti 😂"
                        ],

                        // Respuestas para diferentes tipos de consultas
                        responses: {
                            sintomas: [
                                "¡Ajá! Tu intestino está haciendo gimnasia sin avisar 🏃‍♂️",
                                "Mira, si tu barriga suena como una orquesta, es que algo está pasando 🎼",
                                "Cuando el dolor dice 'hola', hay que responderle con respeto 😤",
                                "Tu estómago es como un GPS: cuando se pierde, te avisa con señales claras 🗺️",
                                "Si tu barriga fuera un teléfono, estaría en modo vibración constante 📱"
                            ],
                            tratamiento: [
                                "Los medicamentos son como amigos que vienen a ayudarte, pero hay que tratarlos bien 💊",
                                "Si tu tratamiento fuera un restaurante, ¿qué estrella Michelin le darías? ⭐",
                                "La medicación es como el papel higiénico: mejor tener de sobra 📜",
                                "Tu tratamiento es como un plan de entrenamiento: constancia es la clave 🎯",
                                "Los medicamentos son como superhéroes: cada uno tiene su poder especial 🦸‍♂️"
                            ],
                            dieta: [
                                "La comida es como el combustible de tu nave espacial intestinal 🚀",
                                "Algunos alimentos son como invitados problemáticos en tu fiesta digestiva 🎉",
                                "Tu dieta es como un jardín: hay que regarla con conocimiento 🌱",
                                "Los alimentos son como actores: algunos son protagonistas, otros son villanos 🎭",
                                "Tu intestino es como un crítico gastronómico muy exigente 👨‍🍳"
                            ],
                            emergencia: [
                                "🚨 ¡ALTO! Si tu barriga hace más ruido que un concierto de rock, llama al médico YA!",
                                "⚠️ Cuando el dolor dice '¡SOS!', no le hagas caso omiso",
                                "📞 Si tu intestino está en modo 'película de terror', es hora de pedir refuerzos",
                                "🚑 Tu barriga no es una discoteca: si hace demasiado ruido, es señal de alarma",
                                "⚡ Si el dolor es más intenso que un meme viral, busca ayuda profesional"
                            ],
                            general: [
                                "¡Excelente pregunta! Tu intestino está orgulloso de tu curiosidad 🧠",
                                "Me encanta cuando la gente pregunta sin miedo. ¡Así se aprende! 📚",
                                "Tu pregunta demuestra que eres un experto en tu propio cuerpo 👏",
                                "¡Bravo! Estás haciendo las preguntas que muchos se callan 🎉"
                            ]
                        },

                        // Chistes escatológicos (siempre con buen gusto)
                        jokes: [
                            "¿Sabes por qué los médicos usan estetoscopios? ¡Para escuchar los chismes del intestino! 🩺",
                            "¿Qué dijo el papel higiénico al inodoro? '¡Nos vemos en la próxima evacuación!' 🧻",
                            "¿Por qué los probióticos son tan populares? ¡Porque son las estrellas del reality show intestinal! 🌟",
                            "¿Qué le dice un intestino sano a uno enfermo? '¡Tú también puedes ser normal!' 💪"
                        ]
                    };

                    function addDoctorPersonality(reply, userMessage) {
                        const lowerMessage = userMessage.toLowerCase();
                        let enhancedReply = reply;

                        // Detectar el tipo de consulta
                        let category = 'general';
                        const keywords = {
                            sintomas: ['dolor', 'síntoma', 'malestar', 'molestia', 'cólico', 'ardor', 'náusea', 'vómito', 'fiebre', 'cansancio'],
                            tratamiento: ['medicamento', 'medicina', 'fármaco', 'tratamiento', 'terapia', 'dosis', 'inyección', 'infusión', 'pastilla'],
                            dieta: ['comida', 'alimento', 'dieta', 'nutrición', 'vitamina', 'suplemento', 'intolerancia', 'alergia', 'comer', 'ingerir'],
                            emergencia: ['urgencia', 'grave', 'crítico', 'sangrado', 'fuerte', 'intenso', 'inmediato', 'sos', 'ayuda']
                        };

                        for (const [cat, words] of Object.entries(keywords)) {
                            if (words.some(word => lowerMessage.includes(word))) {
                                category = cat;
                                break;
                            }
                        }

                        // Añadir solo UNA frase extra, con tacto según la categoría
                        if (category === 'emergencia' || category === 'sintomas') {
                            // Solo una respuesta personalizada, y catchphrase ocasional (no chistes)
                            if (doctorPersonality.responses[category] && Math.random() < 0.7) {
                                const responses = doctorPersonality.responses[category];
                                const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                                enhancedReply += `\n\n${randomResponse}`;
                            }
                            if (Math.random() < 0.2) {
                                const catchphrase = doctorPersonality.catchphrases[Math.floor(Math.random() * doctorPersonality.catchphrases.length)];
                                enhancedReply += `\n\n💭 ${catchphrase}`;
                            }
                            // No añadir chistes en emergencias/síntomas
                        } else {
                            // Para otras categorías, añadir catchphrase o chiste, pero solo uno
                            let extras = [];
                            if (Math.random() < 0.5) {
                                const catchphrase = doctorPersonality.catchphrases[Math.floor(Math.random() * doctorPersonality.catchphrases.length)];
                                extras.push(`💭 ${catchphrase}`);
                            } else if (Math.random() < 0.5) {
                                const joke = doctorPersonality.jokes[Math.floor(Math.random() * doctorPersonality.jokes.length)];
                                extras.push(`😄 ${joke}`);
                            }
                            if (doctorPersonality.responses[category] && Math.random() < 0.5) {
                                const responses = doctorPersonality.responses[category];
                                const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                                extras.unshift(randomResponse);
                            }
                            if (extras.length > 0) {
                                enhancedReply += `\n\n${extras[0]}`; // Solo una frase extra
                            }
                        }

                        return enhancedReply;
                    }

                    sendButton.addEventListener("click", async () => {
                        const userMessage = userInput.value.trim();
                        if (!userMessage) return;

                        const timestamp = new Date().toLocaleString();
                        addMessageWithTimestamp(userMessage, "user", timestamp);
                        userInput.value = "";

                        const typingIndicator = await addTypingIndicator();

                        try {
                            const response = await fetch("https://flatus-webapp.onrender.com/chat", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ message: userMessage }),
                            });
                            const data = await response.json();

                            removeTypingIndicator(typingIndicator);

                            if (data.reply) {
                                // Aplicar personalidad del Doctor Colóncio
                                const personalizedReply = addDoctorPersonality(data.reply, userMessage);
                                addMessageWithTimestamp(personalizedReply, "assistant", new Date().toLocaleString());
                            } else {
                                const errorMessage = "¡Ups! Parece que mi cerebro digestivo tuvo un momento de 'estreñimiento mental'. 😅 Inténtalo de nuevo más tarde.";
                                addMessageWithTimestamp(errorMessage, "assistant", new Date().toLocaleString());
                            }
                        } catch (error) {
                            removeTypingIndicator(typingIndicator);
                            const connectionError = "¡Oh no! Mi conexión intestinal está fallando. 🚽 Es como cuando el WiFi del baño no funciona. Inténtalo de nuevo.";
                            addMessageWithTimestamp(connectionError, "assistant", new Date().toLocaleString());
                        }
                    });

                    userInput.addEventListener("keypress", (event) => {
                        if (event.key === "Enter") {
                            sendButton.click();
                        }
                    });

                    function showWelcomeMessage() {
                        // Verificar si es la primera vez que se abre el chat
                        if (!localStorage.getItem("welcomeShown")) {
                            const welcomeMessage = "¡Hola! Soy el Doctor Colóncio, tu asistente especializado en EII. 🩺\n\n🚽 **Aviso importante:** Justo ahora estoy en el baño usando el papel higiénico. Dame 1 minuto para terminar y lavarme las manos, ¡luego responderé al instante!\n\n💭 \n\n¿En qué puedo ayudarte hoy?";

                            // Agregar el mensaje de bienvenida
                            addMessageWithTimestamp(welcomeMessage, "assistant", new Date().toLocaleString());

                            // Marcar que ya se mostró el mensaje de bienvenida
                            localStorage.setItem("welcomeShown", "true");
                        }
                    }

                    // Variables para el estado del servidor
                    let serverStatus = 'checking';
                    let responseTimes = [];
                    let lastResponseTime = 0;

                    function updateServerStatus(status, text) {
                        const statusDot = document.getElementById('status-dot');
                        const statusText = document.getElementById('status-text');

                        if (statusDot && statusText) {
                            statusDot.className = `status-dot ${status}`;
                            statusText.className = `status-text ${status}`;
                            statusText.textContent = text;
                        }
                    }

                    async function checkServerStatus() {
                        try {
                            const startTime = Date.now();
                            const response = await fetch("https://flatus-webapp.onrender.com/chat", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ message: "ping" }),
                                signal: AbortSignal.timeout(5000) // 5 segundos timeout
                            });

                            const endTime = Date.now();
                            const responseTime = endTime - startTime;

                            if (response.ok) {
                                responseTimes.push(responseTime);
                                if (responseTimes.length > 10) responseTimes.shift(); // Mantener solo los últimos 10

                                const avgResponseTime = Math.round(responseTimes.reduce((a, b) => a + b, 0) / responseTimes.length);
                                lastResponseTime = avgResponseTime;

                                if (responseTime < 2000) {
                                    updateServerStatus('online', `Activo (${avgResponseTime}ms)`);
                                } else {
                                    updateServerStatus('waking', `Despertando (${avgResponseTime}ms)`);
                                }
                            } else {
                                updateServerStatus('offline', 'Error del servidor');
                            }
                        } catch (error) {
                            if (error.name === 'AbortError') {
                                updateServerStatus('offline', 'Sin respuesta');
                            } else {
                                updateServerStatus('offline', 'Error de conexión');
                            }
                        }
                    }

                    // Verificar estado del servidor cada 30 segundos
                    setInterval(checkServerStatus, 30000);

                    window.onload = function () {
                        loadChatHistory();
                        showWelcomeMessage();
                        checkServerStatus(); // Verificar estado inicial
                        renderSuggestions(); // Inicializar sugerencias inteligentes
                    };
                </script>


                <script>
                    function adjustChatHeight() {
                        const inputSection = document.getElementById('input-section');
                        const chatSection = document.getElementById('chat-section');
                        const chatContainer = document.getElementById('chat-container');
                        if (inputSection && chatSection && chatContainer) {
                            const inputHeight = inputSection.offsetHeight;
                            const bottomMargin = 80;
                            const vh = window.innerHeight;
                            const chatHeight = vh - inputHeight - bottomMargin;
                            chatSection.style.height = chatHeight + 'px';
                            chatContainer.style.height = chatHeight + 'px';
                            chatContainer.style.maxHeight = chatHeight + 'px';
                        }
                    }
                    window.addEventListener('resize', adjustChatHeight);
                    window.addEventListener('DOMContentLoaded', adjustChatHeight);
                </script>

                <script src="assets/bootstrap/js/bootstrap.min.js"></script>
                <script src="assets/js/bs-init.js"></script>
                <script src="assets/js/bold-and-bright.js"></script>
                <script src="assets/js/Simple-Slider-swiper-bundle.min.js"></script>
                <script src="assets/js/Simple-Slider.js"></script>
</body>

</html>